import pytest
import pandas as pd
import numpy as np
from ec_tools.helper import cycles_indices, extrema_indices

def test_complex_eclab_initial_potential():
    "The initial potential is positive of some positive vertices. Consequently, the test should fail."
    E = pd.read_csv("./tests/data/eclab-window-opening.tsv")["Ewe/V"].values
    with pytest.raises(ValueError):
        cycles_indices(E, mode="initial")

def test_complex_eclab_vertex():
    "Find all vertices."
    E = pd.read_csv("./tests/data/eclab-window-opening.tsv")["Ewe/V"].values
    indices = cycles_indices(E, mode="vertex")
    neg = np.array([781, 2188, 3595, 5002, 6409, 7816, 9223, 10629, 12037, 13444, 14851, 16258, 17665, 19072, 20479, 21785, 22991, 24097, 25103, 26009, 26813, 27617, 29024, 30479, 31984, 33540, 35146, 36802, 38508, 40214, 41970, 43776, 45632, 47538, 49494, 51499, 53555, 55660, 57713, 59718, 61122, 62426, 63631, 64735, 65739, 66643, 67447, 68251, 69055, 69759, 70363, 72368, 73772, 75127, 76432, 77687, 78842, 79946, 81000, 82004, 82957, 83812, 84616, 86023, 87430, 89135, 91140, 93146, 95150, 97155, 99160, 101165, 103170, 105175, 107180, 109185, 111191, 113195, 115200, 116907, 118314, 119721, 121128, 122535, 124241, 126247, 127952, 129359, 130766, 132173, 133580, 135285, 137291, 141295, 145301, 149305, 151311, 153317, 157320, 161325, 165330, 169335, 171340, 173345, 175350, 177355, 179360, 183880, 185886, 187890, 190159, 192474, 194658, 196711, 198717, 202722, 206726, 209240, 211546, 213652, 215756, 217860, 219864, 221870, 223874, 225880, 227884, 229890, 231894, 233900, 235904, 237910, 239914, 241920, 243924])
    pos = np.array([1483, 2891, 4297, 5705, 7113, 8519, 9927, 11333, 12739, 14147, 15555, 16961, 18369, 19775, 21131, 22388, 23544, 24599, 25556, 26410, 27214, 28320, 29727, 31232, 32737, 34343, 35949, 37655, 39361, 41067, 42873, 44679, 46585, 48491, 50496, 52501, 54606, 56711, 58716, 60420, 61774, 63029, 64193, 65238, 66191, 67045, 67849, 68653, 69408, 70061, 71366, 73070, 74474, 75779, 77084, 78289, 79393, 80497, 81501, 82505, 83409, 84213, 85319, 86726, 88133, 90138, 92122, 94148, 96154, 98158, 100162, 102168, 104172, 106178, 108184, 110188, 112192, 114198, 116202, 117610, 119016, 120424, 121830, 123238, 125244, 127248, 128656, 130062, 131470, 132876, 134282, 136288, 139293, 143299, 147303, 150309, 152313, 155319, 159323, 163329, 167333, 170339, 172345, 174349, 176353, 178359, 180313, 181619, 182925, 184883, 186888, 188893, 191299, 193604, 195709, 197714, 200720, 204724, 207984, 210393, 212600, 214704, 216808, 218862, 220867, 222872, 224877, 226882, 228887, 230892, 232897, 234902, 236907, 238914, 240917, 242922, 244927])
    assert np.all(np.isin(neg, indices.neg))
